---
title: "Projekt SAP"
author: "Pavo Matanović, Karla Baričević, Slavko Boldin"
subtitle: "Tema 2 - Uloga izvoza i uvoza u gospodarstvu"
output:
  pdf_document: default
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(reshape2)

Sys.setlocale(locale = "hr_HR.utf8")
```

# Učitavanje podataka i deskriptivna analiza

Na početku učitavamo podatke i analiziramo kako izgledaju podaci.

```{r}
export.data = read.csv("Export_data.csv", fileEncoding="UTF-8-BOM")
# head(export.data)

import.data = read.csv("Import_data.csv", fileEncoding="UTF-8-BOM")
# head(import.data)

gdp.data = read.csv("GDP_data.csv", fileEncoding="UTF-8-BOM")
# head(gdp.data)

gdp.pc.data = read.csv("GDPpercapita_data.csv", fileEncoding="UTF-8-BOM")
# head(gdp.pc.data)
```

Sljedeći blok koda generira dataframe sa brojem upisanih podataka te brojem procjena među upisanim podacima.

```{r}
export.loc.cnt = export.data %>% group_by(LOCATION) %>%
    summarise(exp_n = n(), exp_est = sum(Flag.Codes == 'E')) %>%
    arrange(desc(exp_n), exp_est)
import.loc.cnt = import.data %>% group_by(LOCATION) %>%
    summarise(imp_n = n(), imp_est = sum(Flag.Codes == 'E')) %>%
    arrange(desc(imp_n), imp_est)
gdp.loc.cnt = gdp.data %>% group_by(LOCATION) %>%
    summarise(gdp_n = n(), gdp_est = sum(Flag.Codes == 'E')) %>%
    arrange(desc(gdp_n), gdp_est)
gdp.pc.loc.cnt = gdp.pc.data %>% group_by(LOCATION) %>%
    summarise(gdp_pc_n = n(), gdp_pc_est = sum(Flag.Codes == 'E')) %>%
    arrange(desc(gdp_pc_n), gdp_pc_est)
loc.cnt = merge(merge(export.loc.cnt, import.loc.cnt), merge(gdp.loc.cnt, gdp.pc.loc.cnt))
knitr::kable(
  head(arrange(loc.cnt,
               desc(loc.cnt[,2]), desc(loc.cnt[,4]), desc(loc.cnt[,6]), desc(loc.cnt[,8]),
               loc.cnt[,3], loc.cnt[,5], loc.cnt[,7], loc.cnt[,9]), 20),
  caption = "Broj podataka za pojedinu državu"
)
```

```{r, include=FALSE}
remove(export.loc.cnt, import.loc.cnt, gdp.loc.cnt, gdp.pc.loc.cnt, loc.cnt)
```

### Odabrane drzave
Odabrali smo USA, Njemačku(DEU) i Grčku(GRC) za analizu.

## Deskriptivna statistika

```{r}
time = 1979:2018
usa = data.frame(year = 1979:2018,
                 export.mln_usd = export.data$Value[export.data$LOCATION == "USA"],
                 import.mln_usd = import.data$Value[import.data$LOCATION == "USA"],
                 gdp.mln_usd = gdp.data$Value[gdp.data$LOCATION == "USA"],
                 gdp.pc.usd_cap = gdp.pc.data$Value[gdp.pc.data$LOCATION == "USA"])
usa$net.trade = usa$export.mln_usd - usa$import.mln_usd
deu = data.frame(year = 1979:2019,
                 export.mln_usd = export.data$Value[export.data$LOCATION == "DEU"],
                 import.mln_usd = import.data$Value[import.data$LOCATION == "DEU"],
                 gdp.mln_usd = gdp.data$Value[gdp.data$LOCATION == "DEU"],
                 gdp.pc.usd_cap = gdp.pc.data$Value[gdp.pc.data$LOCATION == "DEU"])
deu$net.trade = deu$export.mln_usd - deu$import.mln_usd
grc = data.frame(year = 1979:2019,
                 export.mln_usd = export.data$Value[export.data$LOCATION == "GRC"],
                 import.mln_usd = import.data$Value[import.data$LOCATION == "GRC"],
                 gdp.mln_usd = gdp.data$Value[gdp.data$LOCATION == "GRC"],
                 gdp.pc.usd_cap = gdp.pc.data$Value[gdp.pc.data$LOCATION == "GRC"])
grc$net.trade = grc$export.mln_usd - grc$import.mln_usd
```

```{r}
usa = usa %>% mutate(import.mln_usd,
                     import.growth = import.mln_usd - lag(import.mln_usd),
                     import.growth.p = import.growth / lag(import.mln_usd) * 100)
deu = deu %>% mutate(import.mln_usd, 
                     import.growth = import.mln_usd - lag(import.mln_usd),
                     import.growth.p = import.growth / lag(import.mln_usd) * 100)
grc = grc %>% mutate(import.mln_usd,
                     import.growth = import.mln_usd - lag(import.mln_usd),
                     import.growth.p = import.growth / lag(import.mln_usd) * 100)
usa = usa %>% mutate(export.mln_usd, 
                     export.growth = export.mln_usd - lag(export.mln_usd),
                     export.growth.p = export.growth / lag(export.mln_usd) * 100)
deu = deu %>% mutate(export.mln_usd,
                     export.growth = export.mln_usd - lag(export.mln_usd),
                     export.growth.p = export.growth / lag(export.mln_usd) * 100)
grc = grc %>% mutate(export.mln_usd,
                     export.growth = export.mln_usd - lag(export.mln_usd),
                     export.growth.p = export.growth / lag(export.mln_usd) * 100)
usa = usa %>% mutate(gdp.mln_usd,
                     gdp.growth = gdp.mln_usd - lag(gdp.mln_usd),
                     gdp.growth.p = gdp.growth / lag(gdp.mln_usd) * 100)
deu = deu %>% mutate(gdp.mln_usd,
                     gdp.growth = gdp.mln_usd - lag(gdp.mln_usd),
                     gdp.growth.p = gdp.growth / lag(gdp.mln_usd) * 100)
grc = grc %>% mutate(gdp.mln_usd,
                     gdp.growth = gdp.mln_usd - lag(gdp.mln_usd),
                     gdp.growth.p = gdp.growth / lag(gdp.mln_usd) * 100)
usa = usa %>% mutate(gdp.pc.usd_cap,
                     gdp.pc.growth = gdp.pc.usd_cap - lag(gdp.pc.usd_cap),
                     gdp.pc.growth.p = gdp.pc.growth / lag(gdp.pc.usd_cap) * 100)
deu = deu %>% mutate(gdp.pc.usd_cap,
                     gdp.pc.growth = gdp.pc.usd_cap - lag(gdp.pc.usd_cap),
                     gdp.pc.growth.p = gdp.pc.growth / lag(gdp.pc.usd_cap) * 100)
grc = grc %>% mutate(gdp.pc.usd_cap,
                     gdp.pc.growth = gdp.pc.usd_cap - lag(gdp.pc.usd_cap),
                     gdp.pc.growth.p = gdp.pc.growth / lag(gdp.pc.usd_cap) * 100)
# brisemo zadnju opservaciju za deu i grc jer usa nema podatke za 2019.g.
deu = deu[-nrow(deu),]
grc = grc[-nrow(grc),]
```

```{r}
data.all = bind_rows(lapply(c("USA", "DEU", "GRC"), function (x) {
  data.frame(country=x, get(tolower(x)))
}))
data.all$country = factor(data.all$country, levels = c("USA", "DEU", "GRC"))
```

```{r}
summary(usa)
summary(deu)
summary(grc)
```

## Uvoz

Uvozi u mil. USD razlikuju se jako čak i na logaritamskoj skali. Veličine su razmjerne površini države te broju stanovnika.
Za distribucije ukupnog uvoza ne možemo pretpostaviti normalnost, pa nema smisla raditi parametarske testove.

Distribucije postotnog rasta izgledaju normalnije pa ćemo njih uzeti za analizu. Dalje ćemo za postotni rast govoriti samo rast.

```{r fig.height=3}
par(mfrow = c(1, 3), oma = c(0, 0, 2, 0))
hist(usa$import.growth.p, main="USA", xlab="rast %", col="deepskyblue")
hist(deu$import.growth.p, main="DEU", xlab="rast %", col="deepskyblue")
hist(grc$import.growth.p, main="GRC", xlab="rast %", col="deepskyblue")
mtext("Postotni rast uvoza", outer = T, cex = 1.5, font = 2)
```


Distribucije nisu previše zakrivljene i imamo dovoljno podataka da možemo pretpostaviti normalnost distribucije.

Taj zaključak potvrđuju i qq plotovi.

```{r}
qqnorm(usa$import.growth.p)
qqline(usa$import.growth.p, col = "steelblue", lwd = 2)

qqnorm(deu$import.growth.p)
qqline(deu$import.growth.p, col = "steelblue", lwd = 2)

qqnorm(grc$import.growth.p)
qqline(grc$import.growth.p, col = "steelblue", lwd = 2)
```

Odstupanja na krajevima qq plota nam sugeriraju da bi distribucije mogle imati teške repove.

```{r}
ggplot(na.omit(data.all), aes(x=country, y=import.growth.p)) +
  stat_boxplot(geom = "errorbar", width = 0.5) +
  geom_boxplot(aes(fill=country)) +
  labs(title = "Porast uvoza", x="Država", y="Postotak", fill="Država") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

Ovaj plot pokazuje da bi varijable USA i DEU mogle imati istu sredinu.

## Izvoz

```{r}
boxplot(deu$export.mln_usd,
        usa$export.mln_usd,
        grc$export.mln_usd,
        names = c("DEU", "USA", "GRC"), main = "Sredine izvoza",
        col = c("deepskyblue2", "deepskyblue3", "deepskyblue"),
        ylab = "mln USD (log skala)",
        log = "y")
```

Podaci su slični kao i kod uvoza, SAD prednjači i u izvozu u odnosu na Njemačku i Grčku.

```{r}
plot(time, deu$export.growth, type = "h", main = "Rast izvoza (DEU)")
```

Za razliku od uvoza koji linearno raste, izvoz više "osjeća" promjene na tržištu (veće fluktuacije), npr. značajan pad izvoza 2009. godine zbog tadašnje svjetske gospodarske krize.

```{r}
boxplot(deu$gdp.mln_usd,
        usa$gdp.mln_usd,
        grc$gdp.mln_usd,
        names = c("DEU", "USA", "GRC"), main = "Sredine BDP-a",
        col = c("deepskyblue2", "deepskyblue3", "deepskyblue"),
        ylab = "mln USD (log skala)",
        log = "y")
```

## BDP

Kao i kod uvoza i izvoza, po čistom BDP-u SAD značajno prednjači, dok je razlika između Njemačke i Grčke veća od one između SAD-a i Njemačke. No, ovaj prikaz možda nije mjerodavan što se tiče razvijenosti. Treba pogledati BDP po stanovniku:
```{r}
boxplot(deu$gdp.pc.usd_cap,
        usa$gdp.pc.usd_cap,
        grc$gdp.pc.usd_cap,
        names = c("DEU", "USA", "GRC"), main = "Sredine BDP-a po stanovniku",
        col = c("deepskyblue2", "deepskyblue3", "deepskyblue"),
        ylab = " USD (log skala)",
        log = "y")

```
Na prikazu BDP-a po stanovniku podaci su normaliziralni brojem stanovnika, razlike nisu toliko značajne, no SAD i dalje prednjači.

```{r}
plot(time, deu$gdp.growth, type = "h", main = "Rast BDP-a (DEU)")
```
BDP Njemačke je u stalnom porastu uz fluktuacije, a jedini pad BDP-a koji primjećujemo vezan je uz gospodarsku krizu 2009. godine, kada primjećujemo i značajne padove u uvozu i izvozu. Rast BDP-a po stanovniku bit će proporcionalan.

## Testiranje hipoteza

### Pretpostavka: Rast izvoza značajno je veći od rasta uvoza za neku državu

```{r}
exp.imp = melt(data.all, id.vars = "country",
               measure.vars = c("export.growth.p", "import.growth.p"), na.rm = T)
ggplot(exp.imp, aes(x = country, y = value, fill = variable)) +
  stat_boxplot(geom = "errorbar", width = 0.5, position = position_dodge(0.75)) +
  geom_boxplot() +
  labs(title = "Export/Import", y="Postotak") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "top")
```

Pogledom na gornji boxplot čini se da se uvoz i izvoz za neku državu ne razlikuju previše.
Jedinu značajniju razliku vidimo za USA. Provjerit ćemo je li to statistički značajno pomoću t-testa.

Prvo ćemo provjeriti jednakost varijanci, ako su jednake moći ćemo koristiti inačicu t-testa sa većom snagom.
Jednakost varijanci provjeravamo F-testom uz razinu značajnosti $\alpha = 0.05$. Za F-test postavljamo sljedeće hipoteze:

\begin{align*}
  H_0 & : \text{Omjer varijanci} = 1 \\
  H_1 & : \text{Omjer varijanci} \neq 1
\end{align*}

```{r}
var.test(usa$export.growth.p, usa$import.growth.p, alternative = "two.sided", na.action = na.omit)
```

P vrijednost testa jednakosti varijanci je veća od razine značajnosti, te pokazuje da se podaci više priklanjaju hipotezi $H_0$, koju ne odbacujemo.

Uz pretpostavku jednakosti varijanci postavit ćemo hipoteze za t-test jednakosti sredina:

\begin{align*}
  H_0 & : \mu_{izvoz} = \mu_{uvoz} \\
  H_1 & : \mu_{izvoz} > \mu_{uvoz}
\end{align*}

Razina značajnosti $\alpha = 0.05$.

```{r}
t.test(usa$export.growth.p, usa$import.growth.p, alternative = "greater", var.equal = TRUE,
       na.action = na.omit)
```

Dobivena p vrijednost testa je veća od razine značajnosti, te ne možemo odbaciti $H_0$.

\textbf{Zaključak:} Uz dane podatke pretpostavka nije ispunjena, tj. ne možemo pokazati da se rast izvoza neke države značajno razlikuje od rasta uvoza.

### Pretpostavka: Rast BDP-a značajno je veći od rasta BDP-a po stanovniku neke države

```{r}
gdp.gdppc = melt(data.all, id.vars = "country",
               measure.vars = c("gdp.growth.p", "gdp.pc.growth.p"), na.rm = T)
ggplot(gdp.gdppc, aes(x = country, y = value, fill = variable)) +
  stat_boxplot(geom = "errorbar", width = 0.5, position = position_dodge(0.75)) +
  geom_boxplot() +
  labs(title = "BDP/BDP po stanovniku", y="Postotak") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), legend.position = "top")
```
Iz gornjeg prikaza ne čini se kao da se BDP i BDP po stanovniku određene države pretjerano razlikuju.
Jedina primjetljivija razlika koju je kod SAD-a. Provjerit ćemo statističku značajnost pomoću t-testa.

Prvo ćemo provjeriti jednakost varijanci F-testom uz razinu značajnosti $\alpha = 0.05$. Za F-test postavljamo sljedeće hipoteze:

\begin{align*}
  H_0 & : \text{Omjer varijanci} = 1 \\
  H_1 & : \text{Omjer varijanci} \neq 1
\end{align*}

```{r}
var.test(usa$gdp.growth.p, usa$gdp.pc.growth.p, alternative = "two.sided", na.action = na.omit)
```
Rezultati F-testa pokazuju da se podaci više priklanjaju hipotezi $H_0$ pa odbacujemo hipotezu $H_1$.
Dakle, uz pretpostavku jednakosti varijanci provest ćemo t-test jednakosti sredina razine značajnosti $\alpha = 0.05$ s hipotezama:

\begin{align*}
  H_0 & : \mu_{BDP} = \mu_{BDP po stanovniku} \\
  H_1 & : \mu_{BDP} > \mu_{BDP po stanovniku}
\end{align*}

```{r}
t.test(usa$gdp.growth.p, usa$gdp.pc.growth.p, alternative = "greater", var.equal = TRUE,
       na.action = na.omit)
```
P vrijednost t-testa manja je od razine značajnosti te odbacujemo $H_0$.

\textbf{Zaključak:} Uz dane podatke pretpostavka je ispunjena, tj. možemo pokazati da se rast BDP-a neke države značajno razlikuje od rasta BDP-a po stanovniku. 
U ovom slučaju radi se o SAD-u.
Interpretacija? Vidimo da se BDP i BDP po stanovniku značajnije razlikuju samo za države koje u promatranom vremenskom razdoblju imaju 
nekakav porast stanovništva, što je ovdje slučaj s SAD-om dok se za Njemačku i Grčku BDP i BDP po stanovniku značajno ne razlikuju. 
Iz ovoga zaključujemo da je BDP po stanovniku smislenije gledati u slučaju kada u promatranom razdoblju imamo porast stanovništva.

Zato u idućem testu koristimo BDP po stanovniku kao pokazatelj rasta gospodarstva.

### Pretpostavka: Prosječni rast gospodarstva neke države značajno je veći u odnosu na druge

```{r}
ggplot(na.omit(data.all), aes(x=country, y=gdp.pc.growth.p)) +
  stat_boxplot(geom = "errorbar", width = 0.5) +
  geom_boxplot(aes(fill=country)) +
  labs(title = "Rast BDP-a po stanovniku", x="Država", y="Postotak", fill="Država") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```
Iz gornjeg prikaza se vidi da se prosječni porasti BDP-a po stanovniku ove tri države ne razlikuju previše.
To možemo pokušati provjeriti ANOVA metodom. Pretpostavke ANOVA-e su nezavisnost podataka, normalna distribucija i homogenost varijanci, pa ćemo homogenost varijanci 
provjeriti Bartletovim testom:

\begin{align*}
  H_0 & : \sigma_{USA}^2 = \sigma_{DEU}^2 = \sigma_{GRC}^2 \\
  H_1 & : \neg H_0.
\end{align*}
razine značajnosti 0.05

```{r}
bartlett.test(gdp.pc.growth.p ~ country, data.all)
```
Dobivena p vrijednost značajno je manja od razine značajnosti što znači da se odbacuje $H_0$ pa ne možemo koristiti ANOVA-u.

Umjesto ANOVA-e provest ćemo neparametarski test, Kruskal-Wallis test razine značajnosti 0.05 za koji pretpostavke zahtjevane parametarskim testovima ne moraju biti ispunjene.
Kruskal-Wallis test slabiji je od ANOVA-e i uspoređuje medijane ali ovaj test u kombinaciji s gornjim prikazom dokazat će približnu jednakost porasta gospodarstva država.

\begin{align*}
  H_0 & : M_{USA} = M_{DEU} = M_{GRC} \\
  H_1 & : \neg H_0.
\end{align*}


```{r}
kruskal.test(gdp.pc.growth.p ~ country, data.all)
```
Dobivena p vrijednost veća je od razine značajnosti testa te zaključujemo da se porasti BDP-a značajno ne razlikuju, podjednaki su kao što se vidi iz boxplota. 
Odbacuje se $H_1$.
